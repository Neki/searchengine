#!/usr/bin/env python3

import argparse
import sys

from searchengine.parser import load_from_cacm_file
from searchengine.search import vectorial_search, boolean_search
from searchengine.evaluation.evaluation import plot_precision_rappel, Request
from searchengine.parser.query import load_from_query_file
from searchengine.parser.result import load_from_results_file
from searchengine.index.process import Weighting

class UnknownMethodError(Exception):

    def __init__(self, message, method_name):
        super().__init__(message)
        self.method_name = method_name

class InvalidId(Exception):
    def __init__(self,message):
        super().__init__(message)

def main():
    parser = argparse.ArgumentParser(description="A simple text search tool.")
    subparsers = parser.add_subparsers(help='sub-command help')
    parser.add_argument("-n", "--answer-count", help="how many answers are returned", type=int, default=500)
    parser.add_argument("-c", "--collection", help="path to the file containing the collection", default="resources/cacm.all")
    parser.add_argument("-t", "--collection-type", help="select the parser used to "
            "load the collection from the disk", default="cacm",
            choices=["cacm", "wikipedia"])
    parser.add_argument("-s", "--stop-words", help="path to the file "
            "containing a list of 'stop words' to ignore when indexing",
            default="resources/common_words")
    parser.add_argument("-w", "--weight_method", help="The method used to perform the weight", default="tfidf",
            choices=["tfidf","tf","ltf"])    
    
    parser_search = subparsers.add_parser('search', help='Search request')
    parser_search.add_argument("request", help="a request string")
    parser_search.add_argument("-m", "--search_method", help="The method used to perform the search", default="vectorial",
            choices=["vectorial"])
    
    parser_evaluation = subparsers.add_parser('eval', help='Request evaluation')
    parser_evaluation.add_argument("request_id", help="a request number")
    parser_evaluation.add_argument("-q", "--requests", help="path to the file containing the requests", default="resources/query.text")
    parser_evaluation.add_argument("-r", "--results", help="path to the file containing the results", default="resources/qrels.text")

    parser_search.set_defaults(func=process_search)
    parser_evaluation.set_defaults(func=process_evaluation)
    args = parser.parse_args()
    args.func(args)

def process_search(args):
    try:
        if args.collection_type == "cacm":
            # documents is an iterator
            documents = load_from_cacm_file(args.collection)
        elif args.collection_type == "wikipedia":
            raise NotImplementedError("Wikipedia parser is not implemented yet.")
        stop_words = None
        with open(args.stop_words) as f:
            stop_words = f.read()
        display_results(args.search_method, get_weight_method(args.weight_method), args.request, documents, stop_words, args.answer_count)
    except FileNotFoundError as e:
        print("Could not find the file at: {0}".format(e.filename), file=sys.stderr)
        sys.exit(1)

def get_weight_method(arg_weight_method):
    if arg_weight_method == "tfidf":
        return Weighting.Tf_Idf
    elif arg_weight_method == "ltf":
        return Weighting.LogTermFrequency
    elif arg_weight_method == "tf":
        return Weighting.TermFrequency
    else:
        raise 'wrong weight method'

def process_evaluation(args):
    try:
        if args.collection_type == "cacm":
            # documents is an iterator
            documents = load_from_cacm_file(args.collection)
        elif args.collection_type == "wikipedia":
            raise NotImplementedError("Wikipedia parser is not implemented yet.")
        stop_words = None
        with open(args.stop_words) as f:
            stop_words = f.read()
        requests = load_from_query_file(args.requests)
        results = load_from_results_file(args.results)
        id = int(args.request_id)
        if id not in requests.keys() or id not in results.keys():
            raise InvalidId("Wrong request number. Must be in [1,64]")
        print("Request : \n")
        print(requests[id])
        print("Pertinant documents : \n")
        print(results[id])
        request = Request(id, requests[id],results[id])
        eval_request("vectorial",get_weight_method(args.weight_method), request, documents, stop_words, args.answer_count)
    except FileNotFoundError as e:
        print("Could not find the file at: {0}".format(e.filename), file=sys.stderr)
        sys.exit(1)

def dispatch_search(search_method,weight_method, request, documents, stop_words, answer_count):
    results = None
    if search_method == "vectorial":
        results = vectorial_search(request, list(documents), stop_words, answer_count, weight_method)
    elif search_method == "boolean":
        results = boolean_search(request, list(documents), stop_words, answer_count)
    else:
        raise UnknownMethodError("Method {0} is not supported".format(method), method)
    return results

def display_results(search_method, weight_method, request, documents, stop_words, answer_count):
    print(dispatch_search(search_method, weight_method, request, documents, stop_words, answer_count))

def eval_request(search_method, weight_method, request, documents, stop_words, answer_count):
    search_results = dispatch_search(search_method, weight_method, request.text, documents, stop_words, answer_count)
    print("\nOur search results :")
    print(search_results)
    plot_precision_rappel(request, search_results)

if __name__ == "__main__":
    try:
        main()
        sys.exit(0)
    except KeyboardInterrupt:
        # Users do not care much for a stacktrace when they Ctrl-C
        print("Exiting...")
        sys.exit(0)
